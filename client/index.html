<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polar Palace</title>
</head>
<body>
        <canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>
        
        <div id="chat-text" style="width:500x;height:100px;overflow-y:scroll">
            <div>Welcome to the game!</div>
        </div>
        <form id="chat-form">
            <input id="chat-input" type="text" style="width:500px"></input>
        </form>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    // chat/canvas stuff
    const chatText = document.getElementById('chat-text');
    const chatInput = document.getElementById('chat-input');
    const chatForm = document.getElementById('chat-form');
    const ctx = document.getElementById("ctx").getContext("2d");
    ctx.font = '30px Arial';

    socket.on('addToChat', (data)=> {
        chatText.innerHTML += '<div>' + data + '</div>';
    });

    socket.on('evalAnswer', (data)=> {
        console.log(data);
    });


    chatForm.onsubmit = (e)=> {
        e.preventDefault();
        if(chatInput.value[0] === '/'){
            socket.emit('evalServer', chatInput.values.slice(1));
        } else {
            socket.emit('sendMsgToServer', chatInput.value);
        }
        chatInput.value = '';
    }
    
    // game stuff

    // init

    // initializes a player using a package sent from server, contains all the data for client side

    class Player {
        constructor(initPack) {
        let self = {};
        self.id = initPack.id;
        self.number = initPack.number;
        self.x = initPack.x;
        self.y = initPack.y;
        self.hp = initPack.hp;
        self.hpMax = initPack.hpMax;
        self.level = initPack.level;
         // draws our characters, their hp bars and their levels.
        self.draw = ()=> {
            let hpWidth = 30 * self.hp / self.hpMax;
            ctx.fillRect(self.x - hpWidth/2, self.y - 40, hpWidth, 4);
            ctx.fillText(self.number, self.x, self.y);

            ctx.fillText(self.level, self.x, self.y-60);
        }
        Player.list[self.id] = self;
        return self;
    }
    }

    Player.list = {};

    // initializes a Projectile using a package sent from server, contains all the data for client side

    class Projectile {
        constructor(initPack) {
        let self = {};
        self.id = initPack.id;
        self.x = initPack.x;
        self.y = initPack.y;

        self.draw = ()=> {
            ctx.fillRect(self.x-5, self.y-5,10,10);
        }
        Projectile.list[self.id] = self;
        return self;
    }
    }

    Projectile.list = {};

    // creates a new player and projectile and adds them to the player and projectile list
    // expect: {player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], projectile:[]}
    socket.on('init', (data)=> {
        for(let i = 0 ; i < data.player.length; i++) {
            new Player (data.player[i]);
        }
        for(let i= 0; i < data.projectile.length; i++) {
            new Projectile(data.projectile[i]);
        }
    })

    //update

    // loops through player and projectile lists, checks if defined, then updates values.
    // if pack is undefined then there's no new information to update or a desync has occurred.
    // expect: {player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], projectile:[]}
    socket.on('update', (data)=> {
        for(let i = 0; i <data.player.length; i++) {
            let pack = data.player[i];
            let p = Player.list[pack.id];
            if(p) {
                if(pack.x !== undefined) {
                    p.x = pack.x;
                }
                if(pack.y !== undefined) {
                    p.y = pack.y;
                }
                if(pack.hp !== undefined) {
                    p.hp = pack.hp;
                }
                if(pack.level !== undefined) {
                    p.level = pack.level;
                }
            }
        }
        for (let i = 0; i < data.projectile.length; i++) {
            let pack = data.projectile[i];
            let b = Projectile.list[data.projectile[i].id];
            if(b) {
                if(pack.x !== undefined) {
                    b.x = pack.x;
                }
                if (pack.y !== undefined) {
                    b.y = pack.y;
                }
            }
        }
    })

    //remove

    // expect: {player : [12323], projectile:[12323,123123]}
    socket.on('remove', (data)=> {
        for(let i = 0; i < data.player.length; i++) {
            delete Player.list[data.player[i]];
        }
        for(let i = 0; i < data.projectile.length; i++) {
            delete Projectile.list[data.projectile[i]];
        }
    });

    // Positional awareness

    // Loop through the players and projectile lists and draw them on the canvas.
    setInterval(()=> {
        ctx.clearRect(0,0,500,500);
        for(let i in Player.list) {
            Player.list[i].draw();
        }
        for(let i in Projectile.list) {
            Projectile.list[i].draw();
        }
    }, 40);

    document.onkeydown = (event)=> {
        // key 68 = d
        if(event.keyCode === 68){
            socket.emit('keyPress', {inputId: 'right', state:true });
        } 
        // key 83 = s
        else if (event.keyCode === 83) {
            socket.emit('keyPress', {inputId: 'down', state:true });
        }
        // key 65 = a
        else if (event.keyCode === 65) {
            socket.emit('keyPress', {inputId: 'left', state:true });
        }
        // key 87 = w
        else if (event.keyCode === 87) {
            socket.emit('keyPress', {inputId: 'up', state:true });
        }
    }

    document.onkeyup = (event)=> {
        // key 68 = d
        if(event.keyCode === 68){
            socket.emit('keyPress', {inputId: 'right', state:false });
        } 
        // key 83 = s
        else if (event.keyCode === 83) {
            socket.emit('keyPress', {inputId: 'down', state:false });
        }
        // key 65 = a
        else if (event.keyCode === 65) {
            socket.emit('keyPress', {inputId: 'left', state:false });
        }
        // key 87 = w
        else if (event.keyCode === 87) {
            socket.emit('keyPress', {inputId: 'up', state:false });
        }
    }

    document.onmousedown = (event) => {
        socket.emit('keyPress', {inputId:'attack', state:true});
    }
    document.onmouseup = (event) => {
        socket.emit('keyPress', {inputId:'attack', state:false});
    }
    document.onmousemove = (event)=> {
        // find relative to center of the canvas
        let x = -250 + event.clientX - 8;
        let y = -250 + event.clientY - 8;
        // find the angle by extracting the y and the x using atan2
        let angle = Math.atan2(y,x) / Math.PI * 180;
        socket.emit('keyPress',{inputId: 'mouseAngle',state:angle});
    }
</script>
</body>
</html>
